%%
%% This is file `pgf-cmykshadings.sty',
%% 
%% Copyright (c) 2018 David Purton <dcpurton@marshwiggle.net>
%% 
%% This work may be distributed and/or modified under the conditions of
%% the LaTeX Project2 Public License, either version 1.3c of this license
%% or (at your option) any later version. The latest version of this
%% license is in
%%    http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
%% This work is "maintained" (as per the LPPL maintenance status)
%% by David Purton.
%% 
%% This work consists of the file style file pgf-cmykshadings.sty and the
%% driver files:
%%   - pgfsys-cmykshadings-pdftex.def
%%   - pgfsys-cmykshadings-xetex.def
%%   - pgfsys-cmykshadings-luatex.def
%%   - pgfsys-cmykshadings-divpdfmx.def
%%
%%
%% All code in these files is taken from the PGF files pgfcoreshade.code.tex,
%% pgfsys-pdftex.def, pgfsys-dvipdfmx.def, and pgfsys-luatex.def
%% Copyright (c) 2006 Till Tantau and then slightly modified to output CMYK
%% gradients instead of RGB ones.
%%
\ProvidesPackage{pgf-cmykshadings}[2018/10/09 CMYK shadings support for PGF (DCP)]

\RequirePackage{pgf}


% macros from pgfcoreshade.code.tex

\def\pgf@parsefunccmyk#1{%
  \edef\temp{{#1}}%
  \expandafter\pgf@convertcmykstring\temp%
  \edef\temp{{\pgf@cmykconv}}%
  \expandafter\pgf@@parsefunccmyk\temp}

\def\pgf@@parsefunccmyk#1{%
  \let\pgf@bounds=\pgfutil@empty%
  \let\pgf@funcs=\pgfutil@empty%
  \let\pgf@psfuncs=\pgfutil@empty%
  \let\pgf@encode=\pgfutil@empty%
  \let\pgf@sys@shading@ranges=\pgfutil@empty%
  \pgf@sys@shading@range@num=0\relax%
  \pgf@parsefirstcmyk[#1; ]%
  \pgf@parselastdomcmyk[#1; ]%
  \pgf@parsemidcmyk[#1; ]%
  \ifx\pgf@bounds\pgfutil@empty%
    \edef\pgf@pdfparseddomain{0 1}%
    \edef\pgf@pdfparsedfunction{\pgf@singlefunc\space}%
  \else%
    \edef\pgf@pdfparseddomain{\pgf@doma\space\pgf@domb}%
    \edef\pgf@pdfparsedfunction{%
      << /FunctionType 3 /Domain [\pgf@doma\space\pgf@domb] /Functions
      [\pgf@funcs\space] /Bounds [\pgf@bounds] /Encode [0 1 \pgf@encode]
      >> }% <<
  \fi%
  \xdef\pgf@psfuncs{\pgf@psfuncs}%
  }

\def\pgf@parsefirstcmyk[cmyk(#1)=(#2,#3,#4,#5)#6]{%
  \pgfmathsetlength\pgf@x{#1}%
  \edef\pgf@sys@shading@start@pos{\the\pgf@x}%
  \pgf@sys@bp@correct\pgf@x%
  \edef\pgf@doma{\pgf@sys@tonumber{\pgf@x}}%
  \edef\pgf@prevx{\pgf@sys@tonumber{\pgf@x}}%
  \pgf@getcmyktuplewithmixin{#2}{#3}{#4}{#5}%
  \edef\pgf@sys@shading@start@cmyk{\pgf@sys@cmyk}%
  \let\pgf@sys@prevcolor=\pgf@sys@shading@start@cmyk%
  \let\pgf@sys@prevpos=\pgf@sys@shading@start@pos%
  \edef\pgf@prevcolor{\pgf@cmyk}%
  \edef\pgf@firstcolor{\pgf@cmyk}}

\def\pgf@parselastdomcmyk[cmyk(#1)=(#2,#3,#4,#5); {%
  \pgfutil@ifnextchar]{%
    \pgfmathsetlength\pgf@x{#1}%
    \edef\pgf@sys@shading@end@pos{\the\pgf@x}%
    \pgf@max=\pgf@x\relax%
    \pgf@sys@bp@correct\pgf@x%
    \edef\pgf@domb{\pgf@sys@tonumber{\pgf@x}}%
    \pgf@getcmyktuplewithmixin{#2}{#3}{#4}{#5}%
    \edef\pgf@sys@shading@end@cmyk{\pgf@sys@cmyk}%
    \pgfutil@gobble}{\pgf@parselastdomcmyk[}}

\def\pgf@parsemidcmyk[cmyk(#1)=(#2,#3,#4,#5); {\pgf@parserestcmyk[}

\def\pgf@parserestcmyk[cmyk(#1)=(#2,#3,#4,#5); {%
  \advance\pgf@sys@shading@range@num by1\relax%
  \pgfutil@ifnextchar]{%
    \pgf@getcmyktuplewithmixin{#2}{#3}{#4}{#5}%
    \edef\pgf@singlefunc{\space%
      << /FunctionType 2 /Domain [0 1] /C0
      [\pgf@prevcolor] /C1 [\pgf@cmyk] /N 1 >> }% <<
    \edef\pgf@funcs{\pgf@funcs\space%
      << /FunctionType 2 /Domain [\pgf@doma\space\pgf@domb] /C0
      [\pgf@prevcolor] /C1 [\pgf@cmyk] /N 1 >> }% <<
    \edef\pgf@psfuncs{\pgf@prevx\space \pgf@cmyk\space \pgf@prevcolor\space pgfshade \pgf@psfuncs}%
    \pgfmathsetlength\pgf@x{#1}%
    \edef\pgf@sys@shading@ranges{\pgf@sys@shading@ranges{{\pgf@sys@prevpos}{\the\pgf@x}{\pgf@sys@prevcolor}{\pgf@sys@cmyk}}}%
    \edef\pgf@sys@prevpos{\the\pgf@x}%
    \let\pgf@sys@prevcolor=\pgf@sys@cmyk%
    \pgfutil@gobble}{%
    \pgfmathsetlength\pgf@x{#1}%
    \pgf@getcmyktuplewithmixin{#2}{#3}{#4}{#5}%
    \edef\pgf@sys@shading@ranges{\pgf@sys@shading@ranges{{\pgf@sys@prevpos}{\the\pgf@x}{\pgf@sys@prevcolor}{\pgf@sys@cmyk}}}%
    \edef\pgf@sys@prevpos{\the\pgf@x}%
    \let\pgf@sys@prevcolor=\pgf@sys@cmyk%
    \edef\pgf@psfuncs{\pgf@prevx\space \pgf@cmyk\space \pgf@prevcolor\space pgfshade \pgf@psfuncs}%
    \pgf@sys@bp@correct\pgf@x%
    \edef\pgf@prevx{\pgf@sys@tonumber{\pgf@x}}%
    \edef\pgf@bounds{\pgf@bounds\space\pgf@sys@tonumber{\pgf@x}}%
    \edef\pgf@encode{\pgf@encode\space0 1}%
    \edef\pgf@singlefunc{\space%
      << /FunctionType 2 /Domain [0 1] /C0
      [\pgf@prevcolor] /C1 [\pgf@cmyk] /N 1 >> }% <<
    \edef\pgf@funcs{\pgf@funcs\space%
      << /FunctionType 2 /Domain [\pgf@doma\space\pgf@domb] /C0
      [\pgf@prevcolor] /C1 [\pgf@cmyk] /N 1 >> }% <<
    \edef\pgf@prevcolor{\pgf@cmyk}%
    \pgf@parserestcmyk[}}

\def\pgf@getcmyktuplewithmixin#1#2#3#4{%
  \pgfutil@definecolor{pgfshadetemp}{cmyk}{#1,#2,#3,#4}%
  \pgfutil@ifundefined{applycolormixins}{}{\applycolormixins{pgfshadetemp}}%
  \pgfutil@extractcolorspec{pgfshadetemp}{\pgf@tempcolor}%
  \expandafter\pgfutil@convertcolorspec\pgf@tempcolor{cmyk}{\pgf@cmykcolor}%
  \expandafter\pgf@getcmyk@@\pgf@cmykcolor!}

\def\pgf@getcmyk@@#1,#2,#3,#4!{%
  \def\pgf@cmyk{#1 #2 #3 #4}%
  \def\pgf@sys@cmyk{{#1}{#2}{#3}{#4}}%
}

\def\pgf@convertcmykstring#1{%
  \def\pgf@cmykconv{}%
  \pgf@converttocmyk#1]%
  }

\def\pgf@converttocmyk{%
  \pgfutil@ifnextchar]{\pgfutil@gobble}%done!
  {%
    \pgfutil@ifnextchar;{\pgf@grabsemicolorcmyk}%
    {%
      \pgfutil@ifnextchar c{\pgf@gobbleccmyk}%
      {%
        \pgfutil@ifnextchar g{\pgf@grabgraycmyk}%
        {%
          \pgfutil@ifnextchar o{\pgf@grabcolorcmyk}%
          {%
            \pgfutil@ifnextchar m{\pgf@grabcmyk}%
            {%
              \pgfutil@ifnextchar r{\pgf@grabrgbcmyk}%
                {\pgferror{Illformed shading
                 specification}\pgf@converttocmyk}%
            }%
          }%
        }%
      }%
    }%
  }%
}

\def\pgf@grabsemicolorcmyk;{%
  \edef\pgf@cmykconv{\pgf@cmykconv; }\pgf@converttocmyk}

\def\pgf@gobbleccmyk c{\pgf@converttocmyk}

\def\pgf@grabrgbcmyk rgb(#1)=(#2,#3,#4){%
  \pgfutil@definecolor{pgf@tempcol}{rgb}{#2,#3,#4}%
  \pgfutil@extractcolorspec{pgf@tempcol}{\pgf@tempcolor}%
  \expandafter\pgfutil@convertcolorspec\pgf@tempcolor{cmyk}{\pgf@cmykcolor}%
  \expandafter\pgf@convgetcmyk@\expandafter{\pgf@cmykcolor}{#1}%
}

\def\pgf@grabcmyk myk(#1)=(#2,#3,#4,#5){%
  \edef\pgf@cmykconv{\pgf@cmykconv cmyk(#1)=(#2,#3,#4,#5)}\pgf@converttocmyk}

\def\pgf@grabgraycmyk gray(#1)=(#2){%
  \edef\pgf@cmykconv{\pgf@cmykconv cmyk(#1)=(0,0,0,#2)}\pgf@converttocmyk}

\def\pgf@grabcolorcmyk olor(#1)=(#2){%
  \pgfutil@colorlet{pgf@tempcol}{#2}%
  \pgfutil@extractcolorspec{pgf@tempcol}{\pgf@tempcolor}%
  \expandafter\pgfutil@convertcolorspec\pgf@tempcolor{cmyk}{\pgf@cmykcolor}%
  \expandafter\pgf@convgetcmyk@\expandafter{\pgf@cmykcolor}{#1}%
}

\def\pgf@convgetcmyk@#1#2{%
  \edef\pgf@cmykconv{\pgf@cmykconv cmyk(#2)=(#1)}\pgf@converttocmyk}

\def\pgfdeclarehorizontalcmykshading{\pgfutil@ifnextchar[\pgf@declarehorizontalcmykshading{\pgf@declarehorizontalcmykshading[]}}%
\def\pgf@declarehorizontalcmykshading[#1]#2#3#4{%
  \expandafter\def\csname pgf@deps@pgfshading#2!\endcsname{#1}%
  \expandafter\ifx\csname pgf@deps@pgfshading#2!\endcsname\pgfutil@empty%
    \pgfsys@horicmykshading{#2}{#3}{#4}%
  \else%
    \expandafter\def\csname pgf@func@pgfshading#2!\endcsname{\pgfsys@horicmykshading}%
    \expandafter\def\csname pgf@args@pgfshading#2!\endcsname{{#3}{#4}}%
    \expandafter\let\csname @pgfshading#2!\endcsname=\pgfutil@empty%
  \fi}

\def\pgfdeclareverticalcmykshading{\pgfutil@ifnextchar[\pgf@declareverticalcmykshading{\pgf@declareverticalcmykshading[]}}%
\def\pgf@declareverticalcmykshading[#1]#2#3#4{%
  \expandafter\def\csname pgf@deps@pgfshading#2!\endcsname{#1}%
  \expandafter\ifx\csname pgf@deps@pgfshading#2!\endcsname\pgfutil@empty%
    \pgfsys@vertcmykshading{#2}{#3}{#4}%
  \else%
    \expandafter\def\csname pgf@func@pgfshading#2!\endcsname{\pgfsys@vertcmykshading}%
    \expandafter\def\csname pgf@args@pgfshading#2!\endcsname{{#3}{#4}}%
    \expandafter\let\csname @pgfshading#2!\endcsname=\pgfutil@empty%
  \fi}

\def\pgfdeclareradialcmykshading{\pgfutil@ifnextchar[\pgf@declareradialcmykshading{\pgf@declareradialcmykshading[]}}%
\def\pgf@declareradialcmykshading[#1]#2#3#4{%
  \expandafter\def\csname pgf@deps@pgfshading#2!\endcsname{#1}%
  \expandafter\ifx\csname pgf@deps@pgfshading#2!\endcsname\pgfutil@empty%
    \pgfsys@radialcmykshading{#2}{#3}{#4}%
  \else%
    \expandafter\def\csname pgf@func@pgfshading#2!\endcsname{\pgfsys@radialcmykshading}%
    \expandafter\def\csname pgf@args@pgfshading#2!\endcsname{{#3}{#4}}%
    \expandafter\let\csname @pgfshading#2!\endcsname=\pgfutil@empty%
  \fi}


\def\pgfusecmykshading#1{%
  \edef\pgf@shadingname{@pgfshading#1}%
  \pgf@tryextensions{\pgf@shadingname}{\pgfalternateextension}%
  \expandafter\pgfutil@ifundefined\expandafter{\pgf@shadingname}%
  {\pgferror{Undefined shading "#1"}}%
  {%
    {%
      \pgfutil@globalcolorsfalse%
      \def\pgf@shade@adds{}%
      \pgfutil@ifundefined{pgf@deps\pgf@shadingname}%
      {}%
      {%
        \edef\@list{\csname pgf@deps\pgf@shadingname\endcsname}%
        \pgfutil@for\@temp:=\@list\do{%
          {%
            \pgfutil@ifundefined{applycolormixins}{}{\applycolormixins{\@temp}}%
            \pgfutil@extractcolorspec{\@temp}{\pgf@tempcolor}%
            \expandafter\pgfutil@convertcolorspec\pgf@tempcolor{cmyk}{\pgf@cmykcolor}%
            \xdef\pgf@shade@adds{\pgf@shade@adds,\pgf@cmykcolor}%
          }%
        }%
      }%
      \expandafter\pgf@strip@shadename\pgf@shadingname!!%
      \pgfutil@ifundefined{@pgfshading\pgf@basename\pgf@shade@adds!}%
      {%
        {%
          \expandafter\def\expandafter\@temp\expandafter{\csname pgf@func\pgf@shadingname\endcsname}%
          \edef\@args{{\pgf@basename\pgf@shade@adds}}%
          \expandafter\expandafter\expandafter\def%
          \expandafter\expandafter\expandafter\@@args%
          \expandafter\expandafter\expandafter{\csname pgf@args\pgf@shadingname\endcsname}%
          \expandafter\expandafter\expandafter\@temp\expandafter\@args\@@args%
          %
        }%
      }%
      {}%
      \pgf@invokeshading{\csname @pgfshading\pgf@basename\pgf@shade@adds!\endcsname}%
    }%
  }%
}

% allow cmyk colours to be directly specified in shadings

\def\pgf@converttorgb{%
  \pgfutil@ifnextchar]{\pgfutil@gobble}%done!
  {%
    \pgfutil@ifnextchar;{\pgf@grabsemicolor}%
    {%
      \pgfutil@ifnextchar c{\pgf@gobblec}%
      {%
        \pgfutil@ifnextchar g{\pgf@grabgray}%
        {%
          \pgfutil@ifnextchar o{\pgf@grabcolor}%
          {%
            \pgfutil@ifnextchar m{\pgf@grabcmykrgb}%
            {%
              \pgfutil@ifnextchar r{\pgf@grabrgb}%
                {\pgferror{Illformed shading
                 specification}\pgf@converttorgb}%
            }%
          }%
        }%
      }%
    }%
  }%
}

\def\pgf@gobblec c{\pgf@converttorgb}

\def\pgf@grabcmykrgb myk(#1)=(#2,#3,#4,#5){%
  \pgfutil@definecolor{pgf@tempcol}{cmyk}{#2,#3,#4,#5}%
  \pgfutil@extractcolorspec{pgf@tempcol}{\pgf@tempcolor}%
  \expandafter\pgfutil@convertcolorspec\pgf@tempcolor{rgb}{\pgf@rgbcolor}%
  \expandafter\pgf@convgetrgb@\expandafter{\pgf@rgbcolor}{#1}%
}

\def\pgf@grabcolor olor(#1)=(#2){%
  \pgfutil@colorlet{pgf@tempcol}{#2}%
  \pgfutil@extractcolorspec{pgf@tempcol}{\pgf@tempcolor}%
  \expandafter\pgfutil@convertcolorspec\pgf@tempcolor{rgb}{\pgf@rgbcolor}%
  \expandafter\pgf@convgetrgb@\expandafter{\pgf@rgbcolor}{#1}%
}

% load the correct driver

\def\pgfutilgetcmykshadingsdriver{%
  \expandafter\pgfutil@getcmykshadingsdriver\pgfsysdriver[
}
\def\pgfutil@getcmykshadingsdriver pgfsys-#1[{%
  \edef\pgfsyscmykshadingsdriver{pgfsys-cmykshadings-#1}%
}

\pgfutilgetcmykshadingsdriver

\input\pgfsyscmykshadingsdriver


% style options to make use CMYK gradients by default or not

\def\pgfdeclarehorizontalrgbshading{\pgfutil@ifnextchar[\pgf@declarehorizontalrgbshading{\pgf@declarehorizontalrgbshading[]}}%
\def\pgfdeclareverticalrgbshading{\pgfutil@ifnextchar[\pgf@declareverticalrgbshading{\pgf@declareverticalrgbshading[]}}%
\def\pgfdeclareradialrgbshading{\pgfutil@ifnextchar[\pgf@declareradialrgbshading{\pgf@declareradialrgbshading[]}}%

\let\pgf@declarehorizontalrgbshading\pgf@declarehorizontalshading
\let\pgf@declareverticalrgbshading\pgf@declareverticalshading
\let\pgf@declareradialrgbshading\pgf@declareradialshading
\let\pgfusergbshading\pgfuseshading

\newif\ifpgf@cmykshading@default

\DeclareOption{cmyk}{%
  \pgf@cmykshading@defaulttrue
}

\DeclareOption{rgb}{%
  \pgf@cmykshading@defaultfalse
}

\ExecuteOptions{cmyk}

\ProcessOptions\relax

\def\pgf@declarehorizontalshading[#1]#2#3#4{%
  \ifx\@@mod\XC@mod@cmyk
    \pgf@declarehorizontalcmykshading[#1]{#2}{#3}{#4}%
  \else
    \ifx\@@mod\XC@mod@rgb
      \pgf@declarehorizontalrgbshading[#1]{#2}{#3}{#4}%
    \else
      \ifpgf@cmykshading@default
        \pgf@declarehorizontalcmykshading[#1]{#2}{#3}{#4}%
      \else
        \pgf@declarehorizontalrgbshading[#1]{#2}{#3}{#4}%
      \fi
    \fi
  \fi
}

\def\pgf@declareverticalshading[#1]#2#3#4{%
  \ifx\@@mod\XC@mod@cmyk
    \pgf@declareverticalcmykshading[#1]{#2}{#3}{#4}%
  \else
    \ifx\@@mod\XC@mod@rgb
      \pgf@declareverticalrgbshading[#1]{#2}{#3}{#4}%
    \else
      \ifpgf@cmykshading@default
        \pgf@declareverticalcmykshading[#1]{#2}{#3}{#4}%
      \else
        \pgf@declareverticalrgbshading[#1]{#2}{#3}{#4}%
      \fi
    \fi
  \fi
}

\def\pgf@declareradialshading[#1]#2#3#4{%
  \ifx\@@mod\XC@mod@cmyk
    \pgf@declareradialcmykshading[#1]{#2}{#3}{#4}%
  \else
    \ifx\@@mod\XC@mod@rgb
      \pgf@declareradialrgbshading[#1]{#2}{#3}{#4}%
    \else
      \ifpgf@cmykshading@default
        \pgf@declareradialcmykshading[#1]{#2}{#3}{#4}%
      \else
        \pgf@declareradialrgbshading[#1]{#2}{#3}{#4}%
      \fi
    \fi
  \fi
}

\def\pgfuseshading#1{%
  \ifx\@@mod\XC@mod@cmyk
    \pgfusecmykshading{#1}%
  \else
    \ifx\@@mod\XC@mod@rgb
      \pgfusergbshading{#1}%
    \else
      \ifpgf@cmykshading@default
        \pgfusecmykshading{#1}%
      \else
        \pgfusergbshading{#1}%
      \fi
    \fi
  \fi
}

\endinput

